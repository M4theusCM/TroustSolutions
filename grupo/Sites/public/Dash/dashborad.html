<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <title>Dashboard</title>
  <link rel="icon" type="image/x-icon" href="../src/Logo-icon.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Chewy&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');

    * {
      font-family: "Poppins";
    }

    body {
      font-family: "Poppins";
    }
  </style>
</head>

<body onload="iniciar()">
  <div class="div-pai">
    <!-- Menu Lateral -->
    <div class="container-lateral">
      <div class="menu-lateral" id="menu_lateral">
        <div class="topo">
          <div class="logo">
            <img src="../src/Logo-icon.png" alt="TroustSolutions">
            <h2><span>Troust</span>Solutions</h2>
          </div>
          <div class="links links-ativo">
            <a href="./dashborad.html">Home</a>
          </div>
          <div class="links ">
            <a href="./dash-tanque.html">Tanque</a>
          </div>
          <div class="links ">
            <a href="https://troustsolutions.atlassian.net/servicedesk/customer/portal/2" target="_blank">Suporte</a>
          </div>
          <!-- <div class="links">
                        <a href="./dashborad.html">Funcionario</a>
                    </div> -->

        </div>
        <div class="sair links">
          <a href="../index.html">
            <img src="../src/icon-desconectar.png" alt="Icon">
            Desconectar
          </a>
        </div>
      </div>
    </div>

    <!-- Infos Nav -->
    <div class="container-principal">
      <nav>
        <div class="empresa">
          <p>Dashboard</p>
          <span>TroustSolutions</span>
        </div>
        <div class="funcionario">
          <div>
            <p>Bem Vindo</p>
            <p>Convidado</p>
          </div>
          <div>
            <img src="../src/icon-perfil.png" alt="Foto">
          </div>
        </div>
      </nav>

      <div class="container-kpi">
        <div class="kpis">
          <div class="titulo">
            <h3>Qtd. tanques</h3>
          </div>
          <div class="dados">
            <h1>2</h1>
          </div>
        </div>
        <div class="kpis">
          <div class="titulo">
            <h3>Qtd. Sensores</h3>
          </div>
          <div class="dados">
            <h1>3</h1>
          </div>
        </div>
        <div class="kpis">
          <div class="titulo">
            <h3>Alertas</h3>
          </div>
          <div class="dados">
            <h1>0</h1>
          </div>
        </div>
      </div>
      <div class="container-grafico">
        <div class="grafico">
          <canvas id="grafico"></canvas>
        </div>
      </div>

    </div>
  </div>
  <a class="modal-alerta" id="Modal_alerta_tanque" href="./dash-tanque.html">
    <div class="infos-alerta ">
      Alerta: <span id="span_nome_tanque">Tanque Principal</span>
    </div>
    <div class="dados">
      <div class="estatisticas">
        <h1>Temperatura: <span id="span_temp_tanque"></span>°c</h1>
        <h2>Setor: <span id="span_setor_tanque"></span></h2>
      </div>
      <div class="img">
        <img src="../src/icons/alerta.gif">
      </div>
    </div>
  </a>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
  function iniciar() {
    alertaTanque()
    setInterval(() => {
      alertaTanque()
    }, 5000)
  }
  var fkEmpresa = sessionStorage.FK_EMPRESA;
  window.onload = obterDadosGrafico(fkEmpresa);

  // O gráfico é construído com três funções:
  // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
  // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
  // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

  // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
  // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
  // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function obterDadosGrafico(fkEmpresa) {
    // if (proximaAtualizacao != undefined) {
    //   clearTimeout(proximaAtualizacao);
    // }



    fetch(`/medidas/ultimas/${fkEmpresa}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGrafico(resposta);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

    alertaTanque()
    setInterval(() => {
      alertaTanque()
    }, 5000)
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta) {

    console.log('iniciando plotagem do gráfico...');

    // Criando estrutura para plotar gráfico - labels
    let labels = [];

    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: labels, // nomes dos tanques
      datasets: [{
        label: 'Temperatura dos Tanques',
        data: [], // médias
        borderWidth: 2,
        borderColor: '#c400ff',
        backgroundColor: 'rgba(196, 0, 255, 0.25)',
        hoverBackgroundColor: 'rgba(196, 0, 255, 0.45)',
        hoverBorderColor: '#c400ff',
        borderRadius: 12,    // deixa as barras arredondadas
        barThickness: 80   // deixa as barras mais grossas
      }],
      options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#ffffff',
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          },
          title: {
            display: true,
            text: 'Temperatura Média dos Tanques',
            color: '#ffffff',
            font: {
              size: 20,
              weight: 'bold'
            },
            padding: {
              top: 10,
              bottom: 20
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#ffffff',
              font: { size: 13 }
            },
            grid: {
              display: false
            }
          },
          y: {
            ticks: {
              color: '#ffffff',
              font: { size: 13 }
            },
            grid: {
              color: 'rgba(255,255,255,0.2)' // grade bem suave
            }
          }
        }
      }
    };

    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < resposta.length; i++) {
      labels.push(resposta[i].nomeTanque);
      dados.datasets[0].data.push(resposta[i].mediaTanque);
    }

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets)
    console.log('----------------------------------------------')

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'bar',
      data: dados,
    };

    // Adicionando gráfico criado em div na tela
    let myChart = new Chart(
      document.getElementById(`grafico`),
      config
    );
    // setTimeout(() => atualizarGrafico(dados, myChart), 2000);
  }


  // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
  // buscando a última medida inserida em tabela contendo as capturas, 

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function atualizarGrafico(dados, myChart) {



    fetch(`/medidas/tempo-real/`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {

          obterdados(idAquario);
          // alertar(novoRegistro, idAquario);
          console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
          console.log(`Dados atuais do gráfico:`);
          console.log(dados);

          let avisoCaptura = document.getElementById(`avisoCaptura${idAquario}`)
          avisoCaptura.innerHTML = ""


          if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
            console.log("---------------------------------------------------------------")
            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
            avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
            console.log("Horário do novo dado capturado:")
            console.log(novoRegistro[0].momento_grafico)
            console.log("Horário do último dado capturado:")
            console.log(dados.labels[dados.labels.length - 1])
            console.log("---------------------------------------------------------------")
          } else {
            // tirando e colocando valores no gráfico
            dados.labels.shift(); // apagar o primeiro
            dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

            dados.datasets[0].data.shift();  // apagar o primeiro de umidade
            dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

            dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
            dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

            myChart.update();
          }

          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }


  // alerta tanque
  function alertaTanque() {
    console.log('Ta chamando aq')
    console.log('buscar alertas')
    var fkEmpresa = sessionStorage.FK_EMPRESA
    fetch(`/tanques/alertaTanque/${fkEmpresa}`, { cache: "no-store" })
      .then(function (resposta) {
        if (resposta.ok) {
          resposta.json()
            .then(function (alerta) {
              console.log(alerta)
              if (alerta.length > 0) {
                Modal_alerta_tanque.style.display = 'flex'
                span_nome_tanque.innerHTML = alerta[0].nomeTanque
                span_temp_tanque.innerHTML = alerta[0].mediaTanque
                span_setor_tanque.innerHTML = alerta[0].setorTanque
              } else {
                Modal_alerta_tanque.style.display = 'none'
                span_nome_tanque.innerHTML = ''
                span_temp_tanque.innerHTML = ''
                span_setor_tanque.innerHTML = ''
              }
            })
        } else {
          console.log('erro: ', resposta)
        }
      })
  }

</script>